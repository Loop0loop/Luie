// Prisma schema for Luie
// Database: SQLite
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// 프로젝트 - 최상위 단위
model Project {
  id          String   @id @default(uuid())
  title       String
  description String?
  projectPath String?  // 프로젝트 저장 경로
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  chapters    Chapter[]
  characters  Character[]
  terms       Term[]
  snapshots   Snapshot[]
  settings    ProjectSettings?
}

// 프로젝트 설정
model ProjectSettings {
  id              String  @id @default(uuid())
  projectId       String  @unique
  autoSave        Boolean @default(true)
  autoSaveInterval Int    @default(30) // seconds
  
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// 챕터/회차 - 집필 단위
model Chapter {
  id          String   @id @default(uuid())
  projectId   String
  title       String
  content     String   @default("")
  synopsis    String?
  order       Int
  wordCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  snapshots   Snapshot[]
  
  @@index([projectId, order])
}

// 캐릭터 관리
model Character {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  firstAppearance String? // Chapter ID where character first appears
  attributes  String?  // JSON field for flexible attributes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  appearances CharacterAppearance[]
  
  @@index([projectId, name])
}

// 캐릭터 등장 추적
model CharacterAppearance {
  id          String   @id @default(uuid())
  characterId String
  chapterId   String
  position    Int      // Position in text where character appears
  context     String?  // Surrounding text for context
  createdAt   DateTime @default(now())

  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  @@index([characterId, chapterId])
}

// 고유명사 사전
model Term {
  id          String   @id @default(uuid())
  projectId   String
  term        String
  definition  String?
  category    String?  // e.g., "location", "item", "concept"
  firstAppearance String? // Chapter ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  appearances TermAppearance[]
  
  @@index([projectId, term])
}

// 고유명사 등장 추적
model TermAppearance {
  id        String   @id @default(uuid())
  termId    String
  chapterId String
  position  Int
  context   String?
  createdAt DateTime @default(now())

  term      Term     @relation(fields: [termId], references: [id], onDelete: Cascade)
  
  @@index([termId, chapterId])
}

// 스냅샷 (버전 관리)
enum SnapshotType {
  AUTO
  MANUAL
}

model Snapshot {
  id          String   @id @default(uuid())
  projectId   String
  chapterId   String?
  content     String
  contentLength Int     @default(0)
  type        SnapshotType @default(AUTO)
  description String?
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  chapter     Chapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  
  @@index([projectId, createdAt])
}
